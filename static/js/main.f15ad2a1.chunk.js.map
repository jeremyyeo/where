{"version":3,"sources":["ServiceLocation.js","Marker.js","Map.js","index.js"],"names":["Header","styled","div","_templateObject","latestBusLocations","_latestBusLocations","apply","this","arguments","_callee","response","data","services","serviceDetails","regenerator_default","a","wrap","_context","prev","next","fetch","sent","json","Services","map","service","vehicleRef","VehicleRef","serviceID","ServiceID","latLong","Lat","Long","delaySeconds","DelaySeconds","direction","Direction","destination","DestinationStopName","abrupt","t0","stop","ServiceLocation","_this$props","props","activeBusses","busInfo","react_default","createElement","concat","Date","toLocaleString","Component","L","Icon","iconUrl","shadowUrl","iconSize","iconAnchor","popupAnchor","shadowSize","Default","prototype","_getIconUrl","mergeOptions","iconRetinaUrl","require","Wrapper","Map_templateObject","width","height","Map","state","location","lat","long","undefined","remove","center","zoom","zoomControl","tileLayer","detectRetina","maxZoom","addTo","marker","bindTooltip","setState","_this2","_this$state$location","resetMap","markings","markingsGroup","featureGroup","setInterval","Object","asyncToGenerator","mark","allBusses","i","busDelayMins","busDelayString","hasLayer","removeLayer","clearLayers","length","toFixed","Math","abs","circle","color","radius","error","addLayer","_this$state","react","ServiceLocation_ServiceLocation","id","React","AppWrapper","src_templateObject","ReactDOM","render","src_Map","stops","document","getElementById"],"mappings":"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","file":"static/js/main.f15ad2a1.chunk.js","sourcesContent":["import React, { Component } from \"react\";\nimport styled from \"styled-components\";\n\nconst Header = styled.div`\n  margin-top: 0px;\n  font-weight: bold;\n  color: navy;\n`;\n\nfunction sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nexport async function latestBusLocations() {\n  try {\n    let response = await fetch(\n      \"https://cors-anywhere.herokuapp.com/https://www.metlink.org.nz/api/v1/ServiceLocation/3\"\n    );\n    let data = await response.json();\n    let services = data.Services;\n    // await sleep(1000);\n    // response = await fetch(\n    //   \"https://cors-anywhere.herokuapp.com/https://www.metlink.org.nz/api/v1/ServiceLocation/27\"\n    // );\n    // data = await response.json();\n    // let services2 = data.Services;\n    // for (var i = 0; i < services2.length; i++) {\n    //   services.push(services2[i]);\n    // }\n    const serviceDetails = services.map(service => ({\n      vehicleRef: +service.VehicleRef,\n      serviceID: +service.ServiceID,\n      latLong: [+service.Lat, +service.Long],\n      delaySeconds: +service.DelaySeconds,\n      direction: service.Direction,\n      destination: service.DestinationStopName\n    }));\n    return serviceDetails;\n  } catch (error) {\n    return \"An error occured.\";\n  }\n}\n\nexport default class ServiceLocation extends Component {\n  render() {\n    let { activeBusses, busInfo } = this.props;\n    return (\n      <div>\n        <Header>{`${activeBusses} active busses as of ${new Date().toLocaleString()}`}</Header>\n        {/* <pre>{JSON.stringify(busInfo, null, 2)}</pre> */}\n      </div>\n    );\n  }\n}\n","import L from \"leaflet\";\nimport \"leaflet/dist/leaflet.css\";\n\nexport const redIcon = new L.Icon({\n  iconUrl:\n    \"https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png\",\n  shadowUrl:\n    \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png\",\n  iconSize: [20, 30],\n  iconAnchor: [12, 41],\n  popupAnchor: [1, -34],\n  shadowSize: [0, 0]\n});\n\nexport const greenIcon = new L.Icon({\n  iconUrl:\n    \"https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png\",\n  shadowUrl:\n    \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png\",\n  iconSize: [20, 30],\n  iconAnchor: [12, 41],\n  popupAnchor: [1, -34],\n  shadowSize: [0, 0]\n});\n","import React, { Fragment } from \"react\";\nimport L from \"leaflet\";\nimport \"leaflet/dist/leaflet.css\";\nimport styled from \"styled-components\";\nimport ServiceLocation, { latestBusLocations } from \"./ServiceLocation\";\nimport { redIcon, greenIcon } from \"./Marker\";\n\ndelete L.Icon.Default.prototype._getIconUrl;\n\nL.Icon.Default.mergeOptions({\n  iconRetinaUrl: require(\"leaflet/dist/images/marker-icon-2x.png\"),\n  iconUrl: require(\"leaflet/dist/images/marker-icon.png\"),\n  shadowUrl: require(\"leaflet/dist/images/marker-shadow.png\")\n});\n\nconst Wrapper = styled.div`\n  width: ${props => props.width};\n  height: ${props => props.height};\n`;\n\nconst mapProvider =\n  \"https://api.mapbox.com/styles/v1/jeremyyeo/cjudgff9y1ns31fqd2oq29ark/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiamVyZW15eWVvIiwiYSI6ImNqdWRnNmNqaTBrbWM0MHBhN2szMHpiOGsifQ.vVwACv-KjPDdi5Bo7GrjKA\";\nclass Map extends React.Component {\n  state = {\n    location: { lat: -41.301907, long: 174.774041 },\n    activeBusses: 0,\n    busInfo: {}\n  };\n\n  resetMap(lat, long) {\n    if (this.map != undefined) {\n      this.map.remove();\n    }\n    this.map = L.map(\"map\", {\n      center: [lat, long],\n      zoom: 15,\n      zoomControl: false\n    });\n\n    L.tileLayer(mapProvider, {\n      detectRetina: true,\n      maxZoom: 19\n    }).addTo(this.map);\n\n    L.marker([lat, long])\n      .addTo(this.map)\n      .bindTooltip(\"Wellington\");\n  }\n\n  updateState(busInfo) {\n    this.setState();\n  }\n\n  componentDidMount() {\n    let { lat, long } = this.state.location;\n    this.resetMap(lat, long);\n    let markings = 0;\n    this.markingsGroup = L.featureGroup();\n\n    setInterval(async () => {\n      if (this.map.hasLayer(this.markingsGroup) && markings > 1000) {\n        this.map.removeLayer(this.markingsGroup);\n        this.markingsGroup.clearLayers();\n        markings = 0;\n      }\n      let allBusses = await latestBusLocations();\n      try {\n        this.setState({ activeBusses: allBusses.length, busInfo: allBusses });\n        for (var i = 0; i < allBusses.length; i++) {\n          let busDelayMins = allBusses[i].delaySeconds / 60;\n          let busDelayString;\n          // prettier-ignore\n          if (busDelayMins > 0) {\n            busDelayString = `${busDelayMins.toFixed(2)} mins ahead of schedule`;\n          } else if (busDelayMins < 0) {\n            busDelayString = `${Math.abs( busDelayMins.toFixed(2))} mins behind schedule`;\n          } else {\n            busDelayString = \"on time\";\n          }\n\n          L.circle(allBusses[i].latLong, {\n            color: busDelayMins >= 0 ? \"green\" : \"red\",\n            radius: 25\n          })\n            .bindTooltip(\n              `Bus ${allBusses[i].serviceID} (${\n                allBusses[i].vehicleRef\n              }) is ${busDelayString} <br/> heading ${\n                allBusses[i].direction\n              } to ${allBusses[i].destination}.`\n            )\n            .addTo(this.markingsGroup);\n          markings += 1;\n        }\n      } catch (error) {}\n      this.map.addLayer(this.markingsGroup);\n    }, 5000);\n  }\n\n  render() {\n    const { activeBusses, busInfo } = this.state;\n    return (\n      <Fragment>\n        <ServiceLocation activeBusses={activeBusses} busInfo={busInfo} />\n        <Wrapper width=\"100%\" height=\"80vh\" id=\"map\" />\n      </Fragment>\n    );\n  }\n}\n\nexport default Map;\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport \"./index.css\";\nimport styled from \"styled-components\";\nimport Map from \"./Map\";\n\nconst AppWrapper = styled.div`\n  display: grid;\n  grid-template-columns: 100%\n  grid-gap: 10px;\n`;\n\nReactDOM.render(\n  <AppWrapper>\n    <Map stops=\"yes\" />\n  </AppWrapper>,\n  document.getElementById(\"root\")\n);\n"],"sourceRoot":""}